name: Publish to prefix.dev

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REPO_OWNER: devmatteini
  REPO_NAME: dra

jobs:

  ############################################
  # Resolve latest upstream version ONCE
  ############################################
  resolve-version:
    runs-on: ubuntu-latest
    outputs:
      pkg_version: ${{ steps.get_tag.outputs.pkg_version }}
      pkg_sha256: ${{ steps.get_tag.outputs.pkg_sha256 }}

    steps:
      - name: Fetch latest upstream tag and sha256
        id: get_tag
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking ${REPO_OWNER}/${REPO_NAME}"

          TAG=$(curl -s \
            "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/tags" \
            | jq -r '.[0].name')

          if [ "$TAG" = "null" ] || [ -z "$TAG" ]; then
            echo "No tags found"
            exit 1
          fi

          VERSION=${TAG#v}

          ARCHIVE_URL="https://github.com/${REPO_OWNER}/${REPO_NAME}/archive/refs/tags/${VERSION}.tar.gz"

          echo "Latest tag: $TAG"
          echo "Resolved version: $VERSION"
          echo "Archive: $ARCHIVE_URL"

          echo "Downloading archive to compute sha256..."
          SHA256=$(curl -L https://github.com/OWNER/REPO/archive/refs/tags/v1.0.0.tar.gz | sha256sum)

          echo "Computed sha256: $SHA256"

          echo "pkg_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "pkg_sha256=$SHA256" >> "$GITHUB_OUTPUT"

  ############################################
  # Build for each platform
  ############################################
  build-and-publish:
    needs: resolve-version
    runs-on: ${{ matrix.platform.os }}

    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-latest
            target: linux-64
          - os: macos-latest
            target: osx-64
          - os: macos-latest
            target: osx-arm64
          - os: windows-latest
            target: win-64

    permissions:
      id-token: write
      contents: read

    env:
      PKG_VERSION: ${{ needs.resolve-version.outputs.pkg_version }}
      PKG_SHA256: ${{ needs.resolve-version.outputs.pkg_sha256 }}


    steps:
      - uses: actions/checkout@v4

      - name: Print resolved version
        run: echo "Building version $PKG_VERSION"

      - name: Build conda package
        uses: prefix-dev/rattler-build-action@v0.2.34
        env:
          REPO_OWNER: ${{ env.REPO_OWNER }}
          REPO_NAME: ${{ env.REPO_NAME }}
          PKG_VERSION: ${{ env.PKG_VERSION }}
          PKG_SHA256: ${{ env.PKG_SHA256 }}
        with:
          artifact-name: ${{ env.REPO_NAME }}-${{ matrix.platform.target }}
          build-args: >
            --target-platform ${{ matrix.platform.target }}

      - name: Upload packages
        shell: bash
        run: |
          for pkg in $(find output -type f \( -name "*.conda" -o -name "*.tar.bz2" \)); do
            echo "Uploading ${pkg}"
            rattler-build upload prefix -c "${{ github.repository_owner }}" "${pkg}"
          done