name: Publish to prefix.dev

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REPO_OWNER: devmatteini
  REPO_NAME: dra

jobs:

  ############################################
  # Resolve latest upstream version ONCE
  ############################################
  resolve-version:
    runs-on: ubuntu-latest
    outputs:
      pkg_version: ${{ steps.get_tag.outputs.pkg_version }}

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch latest upstream tag
        id: get_tag
        shell: bash
        run: |
          echo "Checking ${REPO_OWNER}/${REPO_NAME}"

          TAG=$(curl -s \
            "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/tags" \
            | jq -r '.[0].name')

          if [ "$TAG" = "null" ] || [ -z "$TAG" ]; then
            echo "No tags found"
            exit 1
          fi

          VERSION=${TAG#v}

          echo "Latest tag: $TAG"
          echo "Resolved version: $VERSION"

          echo "pkg_version=$VERSION" >> "$GITHUB_OUTPUT"

  ############################################
  # Build for each platform
  ############################################
  build-and-publish:
    needs: resolve-version
    runs-on: ${{ matrix.platform.os }}

    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-latest
            target: linux-64
          - os: macos-latest
            target: osx-64
          - os: macos-latest
            target: osx-arm64
          - os: windows-latest
            target: win-64

    permissions:
      id-token: write
      contents: read

    env:
      PKG_VERSION: ${{ needs.resolve-version.outputs.pkg_version }}

    steps:
      - uses: actions/checkout@v4

      - name: Print resolved version
        run: echo "Building version $PKG_VERSION"

      - name: Build conda package
        uses: prefix-dev/rattler-build-action@v0.2.34
        with:
          artifact-name: ${{ env.REPO_NAME }}-${{ matrix.platform.target }}
          build-args: --target-platform ${{ matrix.platform.target }}

      - name: Upload packages
        shell: bash
        run: |
          for pkg in $(find output -type f \( -name "*.conda" -o -name "*.tar.bz2" \)); do
            echo "Uploading ${pkg}"
            rattler-build upload prefix -c "${{ github.repository_owner }}" "${pkg}"
          done